<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat by Linos!</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      color: #333; /* Default color for messages */
      transition: filter 0.5s ease-in-out; /* Transition for background blur */
    }
    
    #chat-container {
      max-width: 600px;
      margin: 50px auto;
      border: 1px solid #ccc;
      border-radius: 10px;
      overflow: hidden;
    }
    
    #chat-messages {
      height: 300px;
      overflow-y: scroll;
      padding: 10px;
      background-color: #f4f4f4;
      user-select: none;
    }
    
    .message-container {
      display: flex;
      flex-direction: column;
    }
    
    .message-bubble {
      max-width: 100%;
      padding: 10px;
      border-radius: 15px;
      margin-bottom: 10px;
      word-wrap: break-word; /* Ensures long text wraps within the message box */
    }
    
    .sent-message {
      background-color: #007aff;
      color: #fff;
      align-self: flex-end;
    }
    
    .received-message {
      background-color: #e5e5ea;
      color: #333; /* Use default color for received messages */
      align-self: flex-start;
    }
    
    .input-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
    }
    
    .username-input,
    .recipient-input,
    #message-input {
      width: calc(50% - 5px);
      padding: 10px;
      border: none;
      border-top: 1px solid #ccc;
      border-radius: 10px 10px 10px 10px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
    
    #image-input {
      width: calc(100% - 5px);
      padding: 10px;
      border: none;
      border-top: 1px solid #ccc;
      border-radius: 10px 10px 10px 10px;
      box-sizing: border-box;
      margin-bottom: 10px;
      background-color: #fff;
      color: black;
    }
    
    #message-input {
      width: calc(85%);
      border-radius: 10px 10px 10px 10px;
    }
    
    .hidden {
      display: none;
    }
    
    .send-btn,
    #file-upload-btn,
    .clear-btn,
    #preview-btn {
      width: calc(15% - 5px);
      padding: 10px;
      border: none;
      color: #ffffff;
      background-color: #007aff;
      border-top: 1px solid #ccc;
      border-radius: 10px 10px 10px 10px;
      box-sizing: border-box;
      margin-bottom: 10px;
      cursor: pointer;
      display: flex; /* Make them flex containers */
      justify-content: center; /* Align text horizontally in the center */
      align-items: center; /* Align text vertically in the center */
      height: 35px; /* Set the height to match other buttons */
    }
    
    #info-container {
      max-width: 600px;
      margin: 0 auto;
      overflow: hidden;
    }
    
    .file-upload-container {
      display: flex;
      align-items: center;
    }
    
    #file-upload-btn {
      width: calc(85%);
      padding: 10px;
      border: none;
      color: #ffffff;
      background-color: #198e12;
      border-top: 1px solid #ccc;
      border-radius: 10px 10px 10px 10px;
      box-sizing: border-box;
      margin-bottom: 10px;
      cursor: pointer;
    }
    
    #file-upload-btn:hover {
      background-color: #B2e6c5;
    }
    
    .send-btn:hover,
    #preview-btn:hover,
    .clear-btn:hover {
      background-color: #5eacff;
    }
    
    #preview-btn {
      width: calc(100%);
      font-size: 16px;
    }

    #file-upload-btn .icon {
      margin-right: 5px;
      vertical-align: middle;
    }
    
    #file-upload-btn span {
      font-size: 16px;
      vertical-align: middle;
    }
    
    .attached {
      background-color: rgb(48, 176, 48) !important;
      border-color: darkgreen !important;
    }
    
    .file-upload-container {
      text-align: center;
      align-items: center;
    }
    
    .clear-btn {
      padding: 10px;
      border: none;
      background-color: #ff3333;
      color: #fff;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      justify-content: center; /* Align text horizontally in the center */
      align-items: center; /* Align text vertically in the center */
      width: calc(15% - 5px); /* Adjust width to match other buttons */
      margin-bottom: 10px;
    }
    
    .clear-btn:hover {
      background-color: #ff6666;
    }
    
    .material-icons {
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 18px;  /* Preferred icon size */
      display: inline-block;
      line-height: 1;
      text-transform: none;
      letter-spacing: normal;
      word-wrap: normal;
      white-space: nowrap;
      direction: ltr;
    
      /* Support for all WebKit browsers. */
      -webkit-font-smoothing: antialiased;
      /* Support for Safari and Chrome. */
      text-rendering: optimizeLegibility;
    
      /* Support for Firefox. */
      -moz-osx-font-smoothing: grayscale;
    
      /* Support for IE. */
      font-feature-settings: 'liga';
    }
    
    .preview-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      z-index: 9999;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
    }
    
    .preview-popup.visible {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }
    #blur-overlay {
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9998; /* Ensure the overlay is behind the preview popup */
}

#blur-overlay.blurred {
  filter: blur(5px); /* Keep the blur effect when added */
}
#typing-indicator {
  background-color: #f4f4f4;
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 10px;
  text-align: center;
  display: none;
}
  </style>
</head>
<body>
  <div id="blur-overlay">
  <div id="chat-container">
    <div id="chat-messages"></div>
      <div id="typing-indicator" style="display: none;"></div> <!-- Typing indicator message container -->
    <div class="input-container" id="input-container">
      <input type="text" class="username-input" id="username-input" placeholder="Your Name">
      <input type="text" class="recipient-input" id="recipient-input" placeholder="Recipient">
      <input type="text" id="message-input" placeholder="Type your message...">
      <button onclick="sendMessage()" class="send-btn">Send</button>
      <label for="image-input" id="file-upload-btn">
        <i class="material-icons icon">cloud_upload</i>
        <span id="file-upload-label">Upload Image</span>
      </label>
      <input type="file" accept="image/*" id="image-input" style="display: none;">
      <button onclick="clearFile()" class="clear-btn">Clear</button> <!-- Clear button for file upload -->
      <button onclick="previewImage()" class="preview-btn" id="preview-btn">Preview Image</button>
    </div>
  </div>
  <div id="info-container">
    <h3 style="text-align:center">How to send images</h3>
    <p style="text-align:center">Paste an image link, or upload an image.</p>
    <hr>
    <h3 style="text-align:center">Formatting</h3>
    <p style="text-align:center">You can use <a href="https://www.markdownguide.org/cheat-sheet/" target="_blank">Markdown Basic Syntax</a>.</p>
  </div>
</div>
  <!-- Preview popup -->
  <div id="preview-popup" class="preview-popup">
    <img id="popup-image" style="max-width: 100%; max-height: 100%;" />
    <div class="close-btn" id="close-preview-btn" onclick="closePreview()">
      <i class="material-icons">close</i>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-storage.js"></script>
  <script>
// Initialize Firebase
const firebaseConfig = {
  apiKey: 'AIzaSyDo9xLGYs3rzhgJKV_qVEyNxCUaRratbXc',
  authDomain: 'https://chat-linos-default-rtdb.firebaseio.com/',
  projectId: 'chat-linos',
  storageBucket: 'gs://chat-linos.appspot.com',
  messagingSenderId: '335597863138',
  appId: '1:335597863138:web:bb28765ae4a27bae99debb'
};

firebase.initializeApp(firebaseConfig);

const database = firebase.database();
const storage = firebase.storage();
const messagesRef = database.ref('dms');
const imagesRef = storage.ref('images');

const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const usernameInput = document.getElementById('username-input');
const recipientInput = document.getElementById('recipient-input');
const inputContainer = document.getElementById('input-container');
const uploadBtn = document.getElementById('file-upload-btn');

// Function to parse URL parameters
function getURLParams() {
  const urlParams = new URLSearchParams(window.location.search);
  const withUser = urlParams.get('with');
  const user = urlParams.get('user');
  return { withUser, user };
}

// Function to populate input fields with URL parameters
function populateInputs() {
  const { withUser, user } = getURLParams();
  if (withUser && user) {
    recipientInput.value = withUser; // Now 'with' parameter is the recipient
    usernameInput.value = user; // Now 'user' parameter is the sender
    usernameInput.classList.add('hidden');
    recipientInput.classList.add('hidden');
    // Call listenForTypingStatus after populating the recipient input
    listenForTypingStatus(user, withUser);
  }
}

populateInputs(); // Call the function to populate inputs when the page loads

// Function to listen for typing status
function listenForTypingStatus(sender, recipient) {
  const typingRef = database.ref('typing');
  const sharedKey = [sender, recipient].sort().join('-');

  // Attach a listener to the typing reference to continuously listen for changes
  typingRef.child(sharedKey).on('value', (snapshot) => {
    console.log("Snapshot:", snapshot.val()); // Log the snapshot data

    // Initialize typing status
    let isTyping = false;

    // Check each entry under the sender-recipient pair
    snapshot.forEach((childSnapshot) => {
      const typingData = childSnapshot.val();
      console.log("Typing data:", typingData); // Log the typing data

      // Check if the user is typing
      if (typingData.sender === recipient && typingData.typing === 'yes') {
        isTyping = true;
      }
    });

    // Show/hide typing indicator message
    const typingIndicator = document.getElementById('typing-indicator');
    if (isTyping) {
      typingIndicator.textContent = `${recipient} is typing...`;
      typingIndicator.style.display = 'block';
    } else {
      typingIndicator.style.display = 'none';
    }
  });
}

// Function to send typing message
function sendTypingMessage(sender, recipient, isTyping) {
  const typingRef = database.ref('typing');

  // Create a shared key to ensure consistent storage of typing status
  const sharedKey = [sender, recipient].sort().join('-');

  // Check if there's an existing entry for the shared key
  typingRef.child(sharedKey).once('value', (snapshot) => {
    if (snapshot.exists()) {
      // Update the existing entries with the new typing status
      snapshot.forEach((childSnapshot) => {
        const typingKey = childSnapshot.key;
        const typingData = childSnapshot.val();
        if (typingData.sender === sender) {
          typingRef.child(sharedKey).child(typingKey).update({
            typing: isTyping ? 'yes' : 'no'
          }, (error) => {
            if (error) {
              console.error('Error updating typing message:', error);
            }
          });
        }
      });
    } else {
      // If no entry exists, create new entries for sender and recipient
      const senderKey = typingRef.child(sharedKey).push().key;
      const recipientKey = typingRef.child(sharedKey).push().key;

      typingRef.child(sharedKey).child(senderKey).set({
        sender: sender,
        typing: isTyping ? 'yes' : 'no'
      });

      typingRef.child(sharedKey).child(recipientKey).set({
        sender: recipient,
        typing: isTyping ? 'yes' : 'no'
      });
    }
  });
}

// Function to send a message
function sendMessage() {
  const message = messageInput.value.trim();
  const sender = usernameInput.value.trim();
  const recipient = recipientInput.value.trim();

  if (message === '') {
    alert('Please enter a message!');
    return;
  }

  const data = {
    sender,
    recipient,
    message,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  };

  messagesRef.push(data);

  // Clear the input field after sending the message
  messageInput.value = '';

  // Send typing status when message is sent
  sendTypingMessage(sender, recipient, false);
}

// Function to handle file upload
function handleFileUpload(file) {
  const reader = new FileReader();

  // Show loading indicator while uploading
  uploadBtn.classList.add('attached');

  reader.onload = function (event) {
    const imageData = event.target.result;
    const imageExtension = file.name.split('.').pop();
    const imageType = `image/${imageExtension}`;

    // Upload image to Firebase Storage
    const imageRef = imagesRef.child(`${Date.now()}.${imageExtension}`);
    imageRef.putString(imageData, 'data_url', { contentType: imageType })
      .then((snapshot) => {
        // Get the download URL of the uploaded image
        return snapshot.ref.getDownloadURL();
      })
      .then((downloadURL) => {
        // Send the image URL as a message
        const message = `![Image](${downloadURL})`;
        const sender = usernameInput.value.trim();
        const recipient = recipientInput.value.trim();

        const data = {
          sender,
          recipient,
          message,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        messagesRef.push(data);

        // Clear the file input field after sending the message
        clearFile();
      })
      .catch((error) => {
        console.error('Error uploading image:', error);
        alert('Error uploading image. Please try again.');
      })
      .finally(() => {
        // Remove loading indicator after upload is complete
        uploadBtn.classList.remove('attached');
      });
  };

  reader.readAsDataURL(file);
}

// Function to clear the file input field
function clearFile() {
  const fileInput = document.getElementById('image-input');
  fileInput.value = '';
}

// Function to preview the image before sending
function previewImage() {
  const fileInput = document.getElementById('image-input');
  const file = fileInput.files[0];

  if (file) {
    const reader = new FileReader();

    reader.onload = function (event) {
      const imageData = event.target.result;
      const popupImage = document.getElementById('popup-image');
      popupImage.src = imageData;

      // Show the preview popup
      const previewPopup = document.getElementById('preview-popup');
      previewPopup.classList.add('visible');
    };

    reader.readAsDataURL(file);
  }
}

// Function to close the image preview popup
function closePreview() {
  const previewPopup = document.getElementById('preview-popup');
  previewPopup.classList.remove('visible');
}

// Add event listeners for file upload
const fileInput = document.getElementById('image-input');
fileInput.addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (file) {
    handleFileUpload(file);
  }
});

// Close the preview popup when clicking outside the image
window.addEventListener('click', (event) => {
  const previewPopup = document.getElementById('preview-popup');
  if (event.target === previewPopup) {
    closePreview();
  }
});

// Listen for changes in the database
messagesRef.on('child_added', (snapshot) => {
  const data = snapshot.val();
  const { sender, recipient, message, timestamp } = data;
  const formattedTime = new Date(timestamp).toLocaleString();

  // Create message bubble
  const messageContainer = document.createElement('div');
  messageContainer.classList.add('message-container');

  const messageBubble = document.createElement('div');
  messageBubble.classList.add('message-bubble');
  messageBubble.textContent = message;

  // Determine if the message was sent or received
  if (sender === usernameInput.value.trim()) {
    messageBubble.classList.add('sent-message');
  } else {
    messageBubble.classList.add('received-message');
  }

  // Append message bubble to container
  messageContainer.appendChild(messageBubble);

  // Append message container to chat messages
  chatMessages.appendChild(messageContainer);

  // Scroll to bottom of chat messages
  chatMessages.scrollTop = chatMessages.scrollHeight;
});

// Listen for changes in the input fields and send typing status
[usernameInput, recipientInput, messageInput].forEach(input => {
  input.addEventListener('input', () => {
    const sender = usernameInput.value.trim();
    const recipient = recipientInput.value.trim();
    sendTypingMessage(sender, recipient, true);
  });
});

// Function to handle focus loss on input fields
[usernameInput, recipientInput, messageInput].forEach(input => {
  input.addEventListener('blur', () => {
    const sender = usernameInput.value.trim();
    const recipient = recipientInput.value.trim();
    sendTypingMessage(sender, recipient, false);
  });
});

</script>
</body>
</html>